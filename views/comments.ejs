<%- include("header",{type:'all'}) %>

	<div class="container">
		<ul class="res_moment">
			<% res_moment.forEach(function(res_moment){ %>
				<li>
					<div class="author">
						<span title="<%= res_moment.name %>"><a href="/posts?author=<%= res_moment.name %> ">author: <%= res_moment.name %></a></span>
					</div>
					<a href="/posts/<%= res_moment.id %>">
						<div class="content markdown">
							<%- res_moment.content %>
						</div>
					</a>
				</li>
			<% }) %>
		</ul>	
	</div>

	<div class="container">
		<ul class="posts">
			<% posts.forEach(function(res){ %>
				<li>
					<div class="cauthor">
						<span title="<%= res.cname %>"><a href="/posts?author=<%= res.cname %> ">author: <%= res.cname %></a></span>
					</div>
					<a href="/posts/<%= res.id %>">
						<div class="content markdown">
							<%- res.ccontent %>
						</div>
					</a>
				</li>
			<% }) %>
		</ul>
	</div>

	<div class="comment_wrap">
		<% if(session.user){ %>
		<form class="form" method="post" action="/<%= posts.id %>">
			<textarea id="spContent" name="content" cols="82"></textarea>
			<div class="submit">发表留言</div>
		</form>
		<% } else{ %>
			<p class="tips">登录之后才可以评论哟</p>
		<% } %>
		<% if (1 < 0) { %>
		<div class="comment_list markdown">
			<% pageOne.forEach(function(res){ %>
				<div class="cmt_lists">
					<div class="cmt_content">
						<div class="userMsg">
							<img src="../images/<%= res['avator'] %>.png" alt=""><span><%= res['name'] %></span>
						</div>
						<div class="cmt_detail">
							<%- res['content'] %>
						</div>
						<span class="cmt_time"><%= res['moment'] %></span>
						<span class="cmt_name">
							<% if(session && session.user ===  res['name']){ %>
								<a class="delete_comment" href="javascript:delete_comment(<%= res['id'] %>);"> 删除</a>
							<% } %>
						</span>
					</div>
				</div>
			<% }) %>
		</div>	
		<% } else{ %>
			<p class="tips">还没有评论，赶快去评论吧！</p>
		<% } %>
		<div style="margin-top: 30px" class="pagination" id="page"></div>	
	</div>


	<script>
		$.ajax({
            url: "<%= posts.id %>/commentPage",
            type: 'POST',
            data:{
                page: 0
            },
            cache: false,
            success: function (msg) {
                console.log("msg!, "+msg)
                if (msg != 'error') {
                    $('.posts').html(' ')
                    $.each(msg,function(i,val){
                        //console.log(val.content)
                        $('.posts').append(
                            '<li>'+
                            '<div class=\"author\">'+
                            '<span title=\"'+ val.mname +'\"><a href=\"/moments?author='+ val.mname +' \">author: '+ val.mname +'</a></span>'+
                            //'<span>评论数：'+ val.comments +'</span>'+
                            //'<span>浏览量：'+ val.pv +'</span>'+
                            '</div>'+
                            '<div class=\"comment_pv\">'+
                            '<span>'+ val.mcontent +'</span>'+
                            '</div>'+
                            '<a href=\"/moments/'+ val.id +'\">'+
                            '<div class=\"title\">'+
                            val.cname +
                            '</div>'+
                            '<div class=\"title\">'+
                            val.ccontent +
                            '</div>'+
                            '<div class=\"content\">'+
                            val.mcontent +
                            '</div>'+
                            '</a>'+
                            '</li>'
                        )
                    })
                }else{
                    alert('分页不存在')
                } 
            }
        })
	</script>
<% include footer %>